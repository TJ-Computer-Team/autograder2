{% extends "base.html" %}

{% load static %}

{% block stylesheet %}
<link rel="stylesheet" type="text/css" href="{% static 'profile.css' %}" />
{% endblock stylesheet %}

{% block title %}Submit{% endblock title %}

{% block content %}
{% if user.particles_enabled %}{% include "partials/particles.html" %}{% endif %}
{% include "partials/header.html" %}
<div class="main-block">
    <div class="title">Submit</div>
    <div class="problem-text">
        Java users, make sure you are
        <a href="https://docs.google.com/document/d/17r0fh2rezqDhNoCoUtwVtExn8hRml0BjeAqxQZk9MCs/edit?usp=sharing" target="_blank">
        naming the class "usercode"
        </a>
    </div>
</div>

<div class="main-block">
    <form action="{% url "runtests:submit_post" %}" method="POST" enctype="multipart/form-data">
        {% csrf_token %}

        <div class="problem-text">
            <select id="problemid" name="problemid">
                {% if problems %}
                    {% for p in problems %}
                        <option value="{{ p.id }}"
                            {% if problem and p.id == problem.id %}selected{% endif %}>
                            {{ p.id }} - {{ p.name }}
                        </option>
                    {% endfor %}
                {% elif problem %}
                    <option value="{{ problem.id }}" selected>{{ problem.id }} - {{ problem.name }}</option>
                {% else %}
                    <option disabled selected>No problems available</option>
                {% endif %}
            </select>
        </div>
        <div class="problem-text">
            <div class="vertAlign">
                <select id="lang" name="lang">
                    
                    <option value="cpp" {% if last_sub_lang == 'cpp' %}selected{% endif %}>C++</option>
                    <option value="java" {% if last_sub_lang == 'java' %}selected{% endif %}>Java</option>
                    <option value="python" {% if last_sub_lang == 'python' %}selected{% endif %}>Python</option>
                </select>

                <!-- Editor Toggle Controls -->
                <div style="margin: 10px 0; padding: 15px; background: #2a2a2a; border-radius: 8px; border: 1px solid #444;">
                    <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 15px;">
                        <span style="color: #ddd; font-weight: bold; font-size: 14px;">Code Editor</span>
                        <div style="display: flex; gap: 2px; background: #333; border-radius: 6px; padding: 2px;">
                            <button type="button" id="advancedBtn" style="padding: 8px 20px; font-size: 12px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; background: white; color: #333; transition: all 0.2s;">
                                On
                            </button>
                            <button type="button" id="simpleBtn" style="padding: 8px 20px; font-size: 12px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; background: #666; color: #ccc; transition: all 0.2s;">
                                Off
                            </button>
                        </div>
                    </div>
                    
                    <!-- ACE Editor -->
                    <div id="aceEditorContainer" style="position: relative;">
                        <div id="aceEditor" style="width: 100%; height: 400px; border: 1px solid #555; border-radius: 4px;"></div>
                        <div style="position: absolute; bottom: 0; right: 0; background: #333; color: #ccc; padding: 4px 8px; font-size: 11px; border-radius: 4px 0 4px 0; border-left: 1px solid #555; border-top: 1px solid #555;">
                            Lines: <span id="lineCount">1</span>
                        </div>
                    </div>
                    
                    <!-- Simple Textarea (hidden by default) -->
                    <div id="simpleEditorContainer" style="display: none; position: relative;">
                <textarea
                    id="codeinput"
                    name="code"
                    rows="20"
                    cols="150"
                    spellcheck="false"
                    maxlength="60000"
                            placeholder="Enter your code here..."
                            style="width: 100%; height: 400px; padding: 10px; background: #1a1a1a; color: white; border: 1px solid #555; border-radius: 4px; font-family: 'Consolas', 'Monaco', 'Courier New', monospace; font-size: 14px; line-height: 1.5; resize: vertical;"></textarea>
                        <div style="position: absolute; bottom: 8px; right: 8px; background: #333; color: #ccc; padding: 4px 8px; font-size: 11px; border-radius: 4px; border: 1px solid #555;">
                            <span id="textareaStats">1 lines • 0 chars</span>
                        </div>
                    </div>
                </div>

                <label class="custom-file-upload">
                    <input type="file" name="files" class="custom-file"/>
                </label>

                <button class="button" type="submit">Submit</button>
            </div>
        </div>
    </form>
</div>

<!-- Input/Output Section -->
<!--
<div class="main-block">
    <div class="title">Input/Output</div>
    <div style="display: flex; gap: 2em; margin-top: 1em;">

        <div style="flex: 1;">
            <div style="margin-bottom: 1em;">
                <div class="problem-text" style="margin-bottom: 0.5em; text-align: left; font-size: 1.2em;">Input</div>
                <textarea 
                    id="inputArea" 
                    placeholder="Enter test input here..."
                    style="width: 100%; height: 200px; padding: 1em; background-color: black; color: white; border: 1px solid #333; border-radius: 0.5em; font-family: monospace; font-size: 1em; line-height: 1.5; resize: vertical; box-sizing: border-box;"
                ></textarea>
                <div style="margin-top: 0.5em; display: flex; gap: 1em;">
                    <button type="button" onclick="clearInput()" class="button" style="padding: 0.5em 1em; width: auto; margin: 0; font-size: 0.8em; background-color: rgb(74, 74, 74); border-radius: 0;" onmouseover="this.style.backgroundColor='rgb(90, 90, 90)'" onmouseout="this.style.backgroundColor='rgb(74, 74, 74)'">Clear</button>
                    <button type="button" onclick="loadSampleInput()" class="button" style="padding: 0.5em 1em; width: auto; margin: 0; font-size: 0.8em; background-color: rgb(30, 51, 156); border-radius: 0;" onmouseover="this.style.backgroundColor='rgb(40, 61, 166)'" onmouseout="this.style.backgroundColor='rgb(30, 51, 156)'">Load Sample</button>
                </div>
            </div>
        </div>
        
        <div style="flex: 1;">
            <div style="margin-bottom: 1em;">
                <div class="problem-text" style="margin-bottom: 0.5em; text-align: left; font-size: 1.2em;">Output</div>
                <div 
                    id="outputArea" 
                    style="width: 100%; height: 200px; padding: 1em; background-color: black; color: white; border: 1px solid #333; border-radius: 0.5em; font-family: monospace; font-size: 1em; line-height: 1.5; box-sizing: border-box; overflow-y: auto; white-space: pre-wrap;"
                >No output yet. Click "Run Code" to test your solution.</div>
                <div style="margin-top: 0.5em; display: flex; gap: 1em;">
                    <button type="button" onclick="clearOutput()" class="button" style="padding: 0.5em 1em; width: auto; margin: 0; font-size: 0.8em; background-color: rgb(74, 74, 74); border-radius: 0;" onmouseover="this.style.backgroundColor='rgb(90, 90, 90)'" onmouseout="this.style.backgroundColor='rgb(74, 74, 74)'">Clear</button>
                    <button type="button" onclick="copyOutput()" class="button" style="padding: 0.5em 1em; width: auto; margin: 0; font-size: 0.8em; background-color: rgb(30, 51, 156); border-radius: 0;" onmouseover="this.style.backgroundColor='rgb(40, 61, 166)'" onmouseout="this.style.backgroundColor='rgb(30, 51, 156)'">Copy</button>
                </div>
            </div>
        </div>
    </div>
    
    <div style="margin-top: 1.5em; text-align: center;">
        <button type="button" onclick="runCode()" class="button" style="padding: 1em 2em; width: auto; margin: 0; font-size: 1.2em; background-color: rgb(34, 139, 34); border-radius: 0;" onmouseover="this.style.backgroundColor='rgb(50, 180, 50)'" onmouseout="this.style.backgroundColor='rgb(34, 139, 34)'">
            ▶ Run Code
        </button>
        <div style="margin-top: 0.5em; color: white; font-size: 1em; font-family: monospace;">
            Test your code locally before submitting
        </div>
    </div>
</div>
-->

<script>
    // Input/Output functionality
    function clearInput() {
        document.getElementById('inputArea').value = '';
    }
    
    function clearOutput() {
        document.getElementById('outputArea').textContent = 'No output yet. Click "Run Code" to test your solution.';
    }
    
    function copyOutput() {
        const output = document.getElementById('outputArea').textContent;
        navigator.clipboard.writeText(output).then(() => {
            // Show brief success message
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = 'Copied!';
            btn.style.background = '#28a745';
            setTimeout(() => {
                btn.textContent = originalText;
                btn.style.background = '#28a745';
            }, 1000);
        });
    }
    
    function loadSampleInput() {
        // Load sample input for the selected problem
        const problemSelect = document.getElementById('problemid');
        const selectedProblem = problemSelect.options[problemSelect.selectedIndex];
        
        if (selectedProblem && selectedProblem.value) {
            // This would typically fetch sample input from the server
            // For now, we'll use placeholder sample input
            const sampleInputs = {
                '1': '5\n1 2 3 4 5\n',
                '2': '3\nhello world\ntest case\nanother test\n',
                '3': '2\n10 20\n'
            };
            
            const sampleInput = sampleInputs[selectedProblem.value] || '// Sample input for problem ' + selectedProblem.text + '\n// Replace this with actual sample input\n';
            document.getElementById('inputArea').value = sampleInput;
        }
    }
    
    function runCode() {
        const input = document.getElementById('inputArea').value;
        const code = currentMode === 'advanced' && aceEditor ? aceEditor.getValue() : document.getElementById('codeinput').value;
        const language = document.getElementById('lang').value;
        
        if (!code.trim()) {
            document.getElementById('outputArea').textContent = 'Error: No code to run. Please enter some code first.';
            return;
        }
        
        // Show running state
        document.getElementById('outputArea').textContent = 'Running code...\n\n';
        
        // Prepare form data (similar to submit button process)
        const formData = new FormData();
        formData.append('lang', language);
        formData.append('code', code);
        formData.append('input', input);
        
        // Send POST request to Django backend (similar to submit button)
        fetch('{% url "runtests:run_code_post" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                document.getElementById('outputArea').textContent = 'Error: ' + data.error;
            } else if (data.success) {
                document.getElementById('outputArea').textContent = data.output;
            } else {
                document.getElementById('outputArea').textContent = 'Unexpected response from server.';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('outputArea').textContent = 'Error: Failed to connect to server.';
        });
    }
    
    // Make runCode globally available
    window.runCode = runCode;
    window.clearInput = clearInput;
    window.clearOutput = clearOutput;
    window.copyOutput = copyOutput;
    window.loadSampleInput = loadSampleInput;
</script>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.14/ace.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.14/ext-language_tools.js"></script>

<script type="text/javascript">
    let aceEditor;
    let currentMode = 'advanced'; // 'advanced' or 'simple'
    let codeValue = '';

    function getLanguageMode(lang) {
        switch (lang) {
            case 'cpp': return 'c_cpp';
            case 'java': return 'java';
            case 'python': return 'python';
            default: return 'text';
        }
    }

    // Initialize ACE Editor
    function initializeAceEditor() {
        aceEditor = ace.edit("aceEditor");
        aceEditor.setTheme("ace/theme/monokai");
        aceEditor.session.setMode(`ace/mode/${getLanguageMode(document.getElementById('lang').value)}`);
        aceEditor.setOptions({
            fontSize: 14,
            showPrintMargin: false,
            wrap: true,
            enableBasicAutocompletion: true,
            enableSnippets: true,
            enableLiveAutocompletion: false,
            tabSize: 2,
            useSoftTabs: true,
            maxLines: 30,
            minLines: 20,
        });
        
        aceEditor.setValue(codeValue);
        aceEditor.clearSelection();
        
        // Update line count and sync value
        aceEditor.session.on('change', function() {
            codeValue = aceEditor.getValue();
            document.getElementById('lineCount').textContent = aceEditor.session.getLength();
            // Sync with hidden textarea for form submission
            if (currentMode === 'advanced') {
                document.getElementById('codeinput').value = codeValue;
            }
        });
        
        // Set initial line count
        document.getElementById('lineCount').textContent = aceEditor.session.getLength();
    }

    // Toggle between editors
    function toggleEditor(mode) {
        const aceContainer = document.getElementById('aceEditorContainer');
        const simpleContainer = document.getElementById('simpleEditorContainer');
        const advancedBtn = document.getElementById('advancedBtn');
        const simpleBtn = document.getElementById('simpleBtn');
        
        if (mode === 'advanced') {
            // Switch to ACE editor
            if (currentMode === 'simple') {
                codeValue = document.getElementById('codeinput').value;
                aceEditor.setValue(codeValue);
                aceEditor.clearSelection();
            }
            
            aceContainer.style.display = 'block';
            simpleContainer.style.display = 'none';
            
            advancedBtn.style.background = 'white';
            advancedBtn.style.color = '#333';
            simpleBtn.style.background = '#666';
            simpleBtn.style.color = '#ccc';
            
            currentMode = 'advanced';
            
        } else {
            // Switch to simple textarea
            if (currentMode === 'advanced') {
                codeValue = aceEditor.getValue();
                document.getElementById('codeinput').value = codeValue;
            }
            
            aceContainer.style.display = 'none';
            simpleContainer.style.display = 'block';
            
            advancedBtn.style.background = '#666';
            advancedBtn.style.color = '#ccc';
            simpleBtn.style.background = 'white';
            simpleBtn.style.color = '#333';
            
            currentMode = 'simple';
            
            updateTextareaStats();
        }
    }

    // Update textarea statistics
    function updateTextareaStats() {
        const textarea = document.getElementById('codeinput');
        const lines = textarea.value.split('\n').length;
        const chars = textarea.value.length;
        document.getElementById('textareaStats').textContent = `${lines} lines • ${chars} chars`;
    }

    // Language change handler
    function handleLanguageChange() {
        if (aceEditor && currentMode === 'advanced') {
            aceEditor.session.setMode(`ace/mode/${getLanguageMode(document.getElementById('lang').value)}`);
        }
    }

    // Initialize everything when page loads
    document.addEventListener('DOMContentLoaded', function() {
        initializeAceEditor();
        
        // Button event listeners
        document.getElementById('advancedBtn').addEventListener('click', function() {
            toggleEditor('advanced');
        });
        
        document.getElementById('simpleBtn').addEventListener('click', function() {
            toggleEditor('simple');
        });
        
        // Language change listener
        document.getElementById('lang').addEventListener('change', handleLanguageChange);
        
        // Textarea event listeners for simple mode
        const textarea = document.getElementById('codeinput');
        textarea.addEventListener('input', function() {
            codeValue = this.value;
            updateTextareaStats();
        });
        
        // Tab key handling for textarea
        textarea.addEventListener("keydown", function (e) {
        const max = 60000;
        const allowed = ['Backspace', 'Delete', 'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown'];
        if (this.value.length >= max && !allowed.includes(e.key)) {
            e.preventDefault();
            return;
        }
        if (e.key === "Tab") {
            e.preventDefault();
            const start = this.selectionStart;
            const end = this.selectionEnd;
            this.value = this.value.substring(0, start) + "\t" + this.value.substring(end);
            this.selectionStart = this.selectionEnd = start + 1;
                updateTextareaStats();
            }
        });
        
        // Form submission handler
        document.querySelector('form').addEventListener('submit', function(e) {
            // Ensure the form gets the current code value
            if (currentMode === 'advanced' && aceEditor) {
                document.getElementById('codeinput').value = aceEditor.getValue();
            }
        });
    });
</script>

{% endblock content %}